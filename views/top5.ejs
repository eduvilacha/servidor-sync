<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Top 5 Compatibilidades</h1>
    <p>Hola <%= usuario.nombre %> 👋, estas son tus coincidencias:</p>

    <% if (top5.length === 0) { %>
        <p>No hay usuarios con los que comparar todavía.</p>
    <% } else { %>
        <% top5.forEach(function(item) { %>
            <div class="contenedor">
                <h3><%= item.usuario.nombre %> ( <%= item.usuario.edad %> años, <%= item.usuario.provincia %>, <%= item.usuario.genero %> )</h3>
                <p>Compatibilidad: <strong><%= item.porcentaje %>%</strong></p>
                
                <!-- clases condicionalmente -->
                <button 
                    class="boton-like 
                        <%= item.estado === 'like' ? 'like-dado' : (item.estado === 'match' ? 'match' : 'normal') %>" 
                    data-id="<%= item.usuario._id %>"
                    data-estado="<%= item.estado || 'normal' %>">
                    <%= item.estado === 'like' ? 'Like dado' : (item.estado === 'match' ? 'Sync!' : '👍 Me gusta') %>
                </button>
            </div>
        <% }) %>
    <% } %>

    <a href="/">Volver al inicio</a>

    <script>
        document.querySelectorAll(".boton-like").forEach(btn => {

            if (btn.dataset.estado === "like") {
                btn.classList.add("like-dado");
                btn.textContent = "Like dado";
            } else if (btn.dataset.estado === "match") {
                btn.classList.add("match");
                btn.textContent = "Sync!";
            }

            btn.addEventListener("click", () => {
                const targetId = btn.getAttribute("data-id");

                fetch("/like", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ targetUserId: targetId })
                })
                .then(res => res.json())
                .then(data => {
                    // Actualizar el estado del botón dependiendo del resultado
                    if (data.estado === "like") {
                        btn.classList.remove("match");
                        btn.classList.add("like-dado");
                        btn.textContent = "Like dado";
                    } else if (data.estado === "match") {
                        btn.classList.remove("like-dado");
                        btn.classList.add("match");
                        btn.textContent = "Sync!";
                    }
                });
            });
        });
    </script>    
</body>
</html>
